{%- set http_port_by_id = {} -%}
{%- set tls_port_by_id = {} -%}
{%- for c in containers -%}
	{%- set http_port = c.labels.get('http-port', '').strip() -%}
	{%- set tls_port = c.labels.get('tls-port', '').strip() -%}
	{%- set ports = c.attrs['HostConfig']['PortBindings'].keys() -%}
	{%- for port in ports -%}
                {%- set portnum = c.attrs['HostConfig']['PortBindings'][port][0]['HostPort'] -%}
		{%- if portnum == http_port -%}
			{%- set _ = http_port_by_id.update({c.id: portnum}) -%}
		{%- elif portnum == tls_port -%}
			{%- set _ = tls_port_by_id.update({c.id: portnum}) -%}
		{%- endif -%}
	{%- endfor -%}
{%- endfor -%}

global
    daemon
    maxconn 4096
    user haproxy
    stats socket /var/run/api.sock user haproxy group haproxy mode 660 level admin expose-fd listeners

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global
    balance roundrobin
    option forwardfor
    option httpclose
    option http-server-close

frontend http-in
    bind *:80
    {%- if tls_cert %}
    bind *:443 ssl crt {{tls_cert}}
    http-request redirect scheme https unless { ssl_fc }
    {%- endif %}

{% for c in containers -%}
    {%- if http_port_by_id[c.id] or tls_port_by_id[c.id] %}
    acl is_docker_be{{loop.index}} hdr_end(host) -i {{c.name}}.{{domain}}
    {%- endif -%}
{%- endfor %}
{% if extra_http_backends -%}
  {%- for name_backend in extra_http_backends.split(',') -%}
    {%- set name, backend = name_backend.split('=', 1) %}
    {%- set host, port = backend.split(':', 1) %}
    acl is_extra_http_be{{loop.index}} hdr_end(host) -i {{ name }}.{{domain}}
  {%- endfor -%}
{%- endif %}
{% if extra_tls_backends -%}
  {%- for name_backend in extra_tls_backends.split(',') -%}
    {%- set name, backend = name_backend.split('=', 1) %}
    {%- set host, port = backend.split(':', 1) %}
    acl is_extra_tls_be{{loop.index}} hdr_end(host) -i {{ name }}.{{domain}}
  {%- endfor -%}
{%- endif %}

{% for c in containers -%}
  {%- if http_port_by_id[c.id] or tls_port_by_id[c.id] %}
    use_backend docker_be{{loop.index}} if is_docker_be{{loop.index}}
  {%- endif -%}
{%- endfor %}
{% if extra_http_backends -%}
  {%- for name_backend in extra_http_backends.split(',') -%}
    {%- set name, backend = name_backend.split('=', 1) %}
    {%- set host, port = backend.split(':', 1) %}
    use_backend extra_http_be{{loop.index}} if is_extra_http_be{{loop.index}}
  {%- endfor -%}
{%- endif %}
{% if extra_tls_backends -%}
  {%- for name_backend in extra_tls_backends.split(',') -%}
    {%- set name, backend = name_backend.split('=', 1) %}
    {%- set host, port = backend.split(':', 1) %}
    use_backend extra_tls_be{{loop.index}} if is_extra_tls_be{{loop.index}}
  {%- endfor -%}
{%- endif %}

{% for c in containers -%}
    {%- if http_port_by_id[c.id] or tls_port_by_id[c.id] %}
backend docker_be{{ loop.index }}
        {%- if http_port_by_id[c.id] %}
	server 1 {{hostname_full}}:{{ http_port_by_id[c.id] }} check maxconn 32
        {%- endif %}
        {%- if tls_port_by_id[c.id] %}
	server 1 {{hostname_full}}:{{ tls_port_by_id[c.id] }} check ssl verify none maxconn 32
        {%- endif %}
    {%- endif %}
{% endfor %}

{% if extra_http_backends -%}
  {%- for name_backend in extra_http_backends.split(',') -%}
    {%- set name, backend = name_backend.split('=', 1) %}
    {%- set host, port = backend.split(':', 1) %}
backend extra_http_be{{ loop.index }}
	balance roundrobin
	option httpclose
	option forwardfor
	server 1 {{ backend }} check maxconn 32
  {%- endfor %}
{%- endif %}

{% if extra_tls_backends -%}
  {%- for name_backend in extra_tls_backends.split(',') -%}
    {%- set name, backend = name_backend.split('=', 1) %}
    {%- set host, port = backend.split(':', 1) %}
backend extra_tls_be{{ loop.index }}
	server 1 {{ backend }} check ssl verify none maxconn 32
  {%- endfor %}
{%- endif %}

listen admin
    bind *:8090
    stats enable
    stats uri /
