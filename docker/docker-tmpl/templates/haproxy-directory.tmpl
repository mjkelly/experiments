{%- set http_port_by_id = {} -%}
{%- set tls_port_by_id = {} -%}
{%- for c in containers -%}
	{%- set http_port = c.labels.get('http-port', '').strip() -%}
	{%- set tls_port = c.labels.get('tls-port', '').strip() -%}
	{%- set ports = c.attrs['HostConfig']['PortBindings'].keys() -%}
	{%- for port in ports -%}
                {%- set portnum = c.attrs['HostConfig']['PortBindings'][port][0]['HostPort'] -%}
		{%- if portnum == http_port -%}
			{%- set _ = http_port_by_id.update({c.id: portnum}) -%}
		{%- elif portnum == tls_port -%}
			{%- set _ = tls_port_by_id.update({c.id: portnum}) -%}
		{%- endif -%}
	{%- endfor -%}
{%- endfor -%}
<html>
<head>
<title>Docker containers under {{domain}}</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<style>
body {
  background: #232323;
  color: white;
}
th, td {
  text-align: left;
  border: none;
  padding: 5px;
} 
table {
  border-collapse: collapse;
}
a, a:hover, a:visited, a:active {
  color: #4c66d0
}
</style>
</head>
<body>

<h1>Docker containers under {{domain}}</h1>
<table>
<tr>
  <th>Name</th>
  <th>Image</th>
</tr>
{% for c in containers %}
<tr>
  {%- if http_port_by_id[c.id] or tls_port_by_id[c.id] %}
    <td><a href="https://{{ c.name }}.{{ domain }}">{{ c.name }}</a></td>
  {%- else %}
    <td>{{ c.name }}</td>
  {%- endif %}
  <td>{{ c.attrs['Config']['Image'] }}</td>
</tr>
{% endfor %}
</table>

{%- if extra_links %}
<h1>Extra Links</h1>
<ul>
  {%- for link in extra_links.split(',') -%}
    {%- set name, href = link.split('=', 1) %}
    <li><a href="{{ href }}">{{ name }}</a></li>
  {%- endfor %}
</ul>
{%- endif %}

<p>
  <small>As of {{now.astimezone().strftime("%Y-%m-%d %H:%M:%S %Z")}}</small>
</p>

</body>
</html>
